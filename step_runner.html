<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.1">
<title>ploigos_step_runner.step_runner API documentation</title>
<meta name="description" content="Constructs a given named StepImplementer using a given configuration, and runs it.">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>ploigos_step_runner.step_runner</code></h1>
</header>
<section id="section-intro">
<p>Constructs a given named StepImplementer using a given configuration, and runs it.</p>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="ploigos_step_runner.step_runner.StepRunner"><code class="flex name class">
<span>class <span class="ident">StepRunner</span></span>
<span>(</span><span>config, results_file_name='step-runner-results.yml', work_dir_path='step-runner-working')</span>
</code></dt>
<dd>
<div class="desc"><p>Enables the running of arbitrary Ploigos steps via StepImplementers.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>config</code></strong> :&ensp;<code>Config, dict, list, str (file</code> or <code>directory)</code></dt>
<dd>A Config object,
or a dictionary that is a valid step runner configuration,
or a string that is a path to a YAML or JSON file that is
a valid step runner configuration,
or a string that is a path to a directory containing one or more
files that are valid YAML or JSON files that are valid
configurations,
or a list of any of the former.</dd>
<dt><strong><code>results_file_name</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>Path to the file for steps to write their results to
Default: step-runner-results.yml</dd>
<dt><strong><code>work_dir_path</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>Path to the working folder for step_implementers for runtime files
Default: step-runner-working</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If given config is not of expected type.</dd>
<dt><code>AssertionError</code></dt>
<dd>If given config contains any invalid configurations.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Bool</code></dt>
<dd>True if step completed successfully
False if step returned an error message</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class StepRunner:
    &#34;&#34;&#34;Enables the running of arbitrary Ploigos steps via StepImplementers.

    Parameters
    ----------
    config : Config, dict, list, str (file or directory)
        A Config object,
        or a dictionary that is a valid step runner configuration,
        or a string that is a path to a YAML or JSON file that is
        a valid step runner configuration,
        or a string that is a path to a directory containing one or more
        files that are valid YAML or JSON files that are valid
        configurations,
        or a list of any of the former.
    results_file_name : str, optional
        Path to the file for steps to write their results to
        Default: step-runner-results.yml
    work_dir_path : str, optional
        Path to the working folder for step_implementers for runtime files
        Default: step-runner-working

    Raises
    ------
    ValueError
        If given config is not of expected type.
    AssertionError
        If given config contains any invalid configurations.

    Returns
    -------
    Bool
        True if step completed successfully
        False if step returned an error message
    &#34;&#34;&#34;

    __DEFAULT_MODULE = &#39;ploigos_step_runner.step_implementers&#39;

    def __init__(
        self,
        config,
        results_file_name=&#39;step-runner-results.yml&#39;,
        work_dir_path=&#39;step-runner-working&#39;
    ):
        if isinstance(config, Config):
            self.__config = config
        else:
            self.__config = Config(config)

        self.__results_file_name = results_file_name
        self.__work_dir_path = work_dir_path

        self.__workflow_result = None

    @property
    def config(self):
        &#34;&#34;&#34;
        Returns
        -------
        Config
            Configuration used by this factory.
        &#34;&#34;&#34;
        return self.__config

    @property
    def results_file_path(self):
        &#34;&#34;&#34;Get the full path to the results file.

        Returns
        -------
        str
            Full path to the results file.
        &#34;&#34;&#34;
        return os.path.join(self.__work_dir_path, self.__results_file_name)

    @property
    def workflow_result_pickle_file_path(self):
        &#34;&#34;&#34;
        Get the full path to the workflow result pickle file.
        (The &#39;pickle&#39; file contains the serialized list of step results.)
        The name of the pickle file is the basename of the results_file_name.

        Returns
        -------
        str
           Full path to the workflow pickle (serialized) file.
        &#34;&#34;&#34;
        pickle_filename = os.path.splitext(self.__results_file_name)[0] + &#39;.pkl&#39;
        return os.path.join(self.__work_dir_path, pickle_filename)

    @property
    def workflow_result(self):
        &#34;&#34;&#34;
        Returns
        -------
        WorkflowResult
            Object containing a list of dictionary of step results
            from previous steps.
        &#34;&#34;&#34;
        if not self.__workflow_result:
            self.__workflow_result = WorkflowResult.load_from_pickle_file(
                pickle_filename=self.workflow_result_pickle_file_path
            )
        return self.__workflow_result

    def run_step(self, step_name, environment=None):
        &#34;&#34;&#34;
        Call the given step.

        Parameters
        ----------
        step_name : str
            Ploigos step to run.
        environment : str, optional
            Name of the environment the step is being run in. Used to determine environment
            specific global defaults and step configuration.

        Raises
        ------
        # todo: doc needs to be updated
        StepRunnerException
            If no StepImplementers have been registered for the given step_name
            If no specific StepImplementer name specified in sub step config
                and no default StepImplementer registered for given step_name.
            If no StepImplementer registered for given step with given implementer name.
        Returns
        -------
        Bool
           True if step completed successfully
           False if step returned an error message
        &#34;&#34;&#34;

        sub_step_configs = self.config.get_sub_step_configs(step_name)
        assert len(sub_step_configs) != 0, \
            f&#34;Can not run step ({step_name}) because no step configuration provided.&#34;

        # for each sub step in the step config get the step implementer and run it
        aggregate_success = True
        for sub_step_config in sub_step_configs:
            sub_step_implementer_name = sub_step_config.sub_step_implementer_name

            step_implementer_class = StepRunner.__get_step_implementer_class(
                step_name,
                sub_step_implementer_name)

            # create the StepImplementer instance
            sub_step = step_implementer_class(
                parent_work_dir_path=self.__work_dir_path,
                config=sub_step_config,
                environment=environment,
                workflow_result=self.workflow_result
            )

            # run the step
            step_result = sub_step.run_step()

            # save the step results
            self.workflow_result.add_step_result(
                step_result=step_result
            )

            # acquire the pickle lock
            with open(
                    self.workflow_result_pickle_file_path + &#39;.lock&#39;,
                    &#39;w&#39;,
                    encoding=&#39;utf-8&#39;
            ) as pickle_lock:
                fcntl.flock(pickle_lock, fcntl.LOCK_EX)

                # we are locked
                try:
                    self.workflow_result.merge_with_pickle_file(
                        pickle_filename=self.workflow_result_pickle_file_path
                    )
                    self.workflow_result.write_to_pickle_file(
                        pickle_filename=self.workflow_result_pickle_file_path
                    )
                    self.workflow_result.write_results_to_yml_file(
                        yml_filename=self.results_file_path
                    )
                finally:
                    fcntl.flock(pickle_lock, fcntl.LOCK_UN)

            # aggregate success
            aggregate_success = (aggregate_success and step_result.success)

            # if this sub step failed and not configured to continue on failure, bail
            # else execute next sub step and continue aggregating success
            if (not step_result.success) and \
                    (not sub_step_config.sub_step_contine_sub_steps_on_failure):
                break

        return aggregate_success

    @staticmethod
    def __get_step_implementer_class(step_name, step_implementer_name):
        &#34;&#34;&#34;Given a step name and a step implementer name dynamically loads the Class.

        Parameters
        ----------
        step_name : str
            Name of the step to load the given step implementer for.
            This is only used if the given step_implementer_name does not include
            a module path.
        step_implementer_name : str
            Either the short name of a StepImplementer class which will be dynamically
            loaded from the &#39;ploigos_step_runner.step_implementers.{step_name}&#39; module or
            A class name that includes a dot seperated module name to load the Class from.

        Returns
        -------
        StepImplementer
            Dynamically loaded subclass of StepImplementer for given step name with
            given step implementer name.

        Raises
        ------
        StepRunnerException
            If could not find class to load
            If loaded class is not a subclass of StepImplementer
        &#34;&#34;&#34;
        parts = step_implementer_name.split(&#39;.&#39;)
        class_name = parts.pop()
        module_name = &#39;.&#39;.join(parts)

        if not module_name:
            step_module_part = step_name.replace(&#39;-&#39;, &#39;_&#39;)
            module_name = f&#34;{StepRunner.__DEFAULT_MODULE}.{step_module_part}&#34;

        clazz = import_and_get_class(module_name, class_name)
        if not clazz:
            raise StepRunnerException(
                f&#34;Could not dynamically load step ({step_name}) step implementer&#34; +
                f&#34; ({step_implementer_name}) from module ({module_name})&#34; +
                f&#34; with class name ({class_name})&#34;
            )
        if not issubclass(clazz, StepImplementer):
            raise StepRunnerException(
                f&#34;Step ({step_name}) is configured to use step implementer&#34; +
                f&#34; ({step_implementer_name}) from module ({module_name}) with&#34; +
                f&#34; class name ({class_name}), and dynamically loads as class ({clazz})&#34; +
                f&#34; which is not a subclass of required parent class ({StepImplementer}).&#34;)

        return clazz</code></pre>
</details>
<h3>Instance variables</h3>
<dl>
<dt id="ploigos_step_runner.step_runner.StepRunner.config"><code class="name">prop <span class="ident">config</span></code></dt>
<dd>
<div class="desc"><h2 id="returns">Returns</h2>
<dl>
<dt><code>Config</code></dt>
<dd>Configuration used by this factory.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def config(self):
    &#34;&#34;&#34;
    Returns
    -------
    Config
        Configuration used by this factory.
    &#34;&#34;&#34;
    return self.__config</code></pre>
</details>
</dd>
<dt id="ploigos_step_runner.step_runner.StepRunner.results_file_path"><code class="name">prop <span class="ident">results_file_path</span></code></dt>
<dd>
<div class="desc"><p>Get the full path to the results file.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Full path to the results file.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def results_file_path(self):
    &#34;&#34;&#34;Get the full path to the results file.

    Returns
    -------
    str
        Full path to the results file.
    &#34;&#34;&#34;
    return os.path.join(self.__work_dir_path, self.__results_file_name)</code></pre>
</details>
</dd>
<dt id="ploigos_step_runner.step_runner.StepRunner.workflow_result"><code class="name">prop <span class="ident">workflow_result</span></code></dt>
<dd>
<div class="desc"><h2 id="returns">Returns</h2>
<dl>
<dt><code>WorkflowResult</code></dt>
<dd>Object containing a list of dictionary of step results
from previous steps.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def workflow_result(self):
    &#34;&#34;&#34;
    Returns
    -------
    WorkflowResult
        Object containing a list of dictionary of step results
        from previous steps.
    &#34;&#34;&#34;
    if not self.__workflow_result:
        self.__workflow_result = WorkflowResult.load_from_pickle_file(
            pickle_filename=self.workflow_result_pickle_file_path
        )
    return self.__workflow_result</code></pre>
</details>
</dd>
<dt id="ploigos_step_runner.step_runner.StepRunner.workflow_result_pickle_file_path"><code class="name">prop <span class="ident">workflow_result_pickle_file_path</span></code></dt>
<dd>
<div class="desc"><p>Get the full path to the workflow result pickle file.
(The 'pickle' file contains the serialized list of step results.)
The name of the pickle file is the basename of the results_file_name.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>&nbsp;</dd>
</dl>
<p>Full path to the workflow pickle (serialized) file.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def workflow_result_pickle_file_path(self):
    &#34;&#34;&#34;
    Get the full path to the workflow result pickle file.
    (The &#39;pickle&#39; file contains the serialized list of step results.)
    The name of the pickle file is the basename of the results_file_name.

    Returns
    -------
    str
       Full path to the workflow pickle (serialized) file.
    &#34;&#34;&#34;
    pickle_filename = os.path.splitext(self.__results_file_name)[0] + &#39;.pkl&#39;
    return os.path.join(self.__work_dir_path, pickle_filename)</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="ploigos_step_runner.step_runner.StepRunner.run_step"><code class="name flex">
<span>def <span class="ident">run_step</span></span>(<span>self, step_name, environment=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Call the given step.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>step_name</code></strong> :&ensp;<code>str</code></dt>
<dd>Ploigos step to run.</dd>
<dt><strong><code>environment</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>Name of the environment the step is being run in. Used to determine environment
specific global defaults and step configuration.</dd>
</dl>
<h2 id="raises">Raises</h2>
<h1 id="todo-doc-needs-to-be-updated">todo: doc needs to be updated</h1>
<dl>
<dt><code>StepRunnerException</code></dt>
<dd>If no StepImplementers have been registered for the given step_name
If no specific StepImplementer name specified in sub step config
and no default StepImplementer registered for given step_name.
If no StepImplementer registered for given step with given implementer name.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Bool</code></dt>
<dd>&nbsp;</dd>
</dl>
<p>True if step completed successfully
False if step returned an error message</p></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="ploigos_step_runner" href="index.html">ploigos_step_runner</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="ploigos_step_runner.step_runner.StepRunner" href="#ploigos_step_runner.step_runner.StepRunner">StepRunner</a></code></h4>
<ul class="">
<li><code><a title="ploigos_step_runner.step_runner.StepRunner.config" href="#ploigos_step_runner.step_runner.StepRunner.config">config</a></code></li>
<li><code><a title="ploigos_step_runner.step_runner.StepRunner.results_file_path" href="#ploigos_step_runner.step_runner.StepRunner.results_file_path">results_file_path</a></code></li>
<li><code><a title="ploigos_step_runner.step_runner.StepRunner.run_step" href="#ploigos_step_runner.step_runner.StepRunner.run_step">run_step</a></code></li>
<li><code><a title="ploigos_step_runner.step_runner.StepRunner.workflow_result" href="#ploigos_step_runner.step_runner.StepRunner.workflow_result">workflow_result</a></code></li>
<li><code><a title="ploigos_step_runner.step_runner.StepRunner.workflow_result_pickle_file_path" href="#ploigos_step_runner.step_runner.StepRunner.workflow_result_pickle_file_path">workflow_result_pickle_file_path</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.1</a>.</p>
</footer>
</body>
</html>
