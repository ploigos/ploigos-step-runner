<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.1">
<title>ploigos_step_runner.utils.containers API documentation</title>
<meta name="description" content="Shared utils for dealing with containers.">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>ploigos_step_runner.utils.containers</code></h1>
</header>
<section id="section-intro">
<p>Shared utils for dealing with containers.</p>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="ploigos_step_runner.utils.containers.add_container_build_step_result_artifacts"><code class="name flex">
<span>def <span class="ident">add_container_build_step_result_artifacts</span></span>(<span>step_result, contaimer_image_registry, container_image_repository, container_image_tag, container_image_digest, container_image_build_address, container_image_build_short_address)</span>
</code></dt>
<dd>
<div class="desc"><p>Helper function to consistently add step results when building a container image.</p>
<p>NOTE: long term probably should move this into some mixin class that all container build
StepImplementers also inherit from, but thats another pattern don't want to introduce right now.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>step_result</code></strong> :&ensp;<code>StepResult</code></dt>
<dd>Step result to add the container build artifacts to.</dd>
<dt><strong><code>contaimer_image_registry</code></strong> :&ensp;<code>str</code></dt>
<dd>Container image registry the image was built into.</dd>
<dt><strong><code>container_image_repository</code></strong> :&ensp;<code>str</code></dt>
<dd>Container image repository the image was built into.</dd>
<dt><strong><code>container_image_tag</code></strong> :&ensp;<code>str</code></dt>
<dd>Container image tag the built image was tagged with.</dd>
<dt><strong><code>container_image_digest</code></strong> :&ensp;<code>str</code></dt>
<dd>Container image digest of built image.</dd>
<dt><strong><code>container_image_build_address</code></strong> :&ensp;<code>str</code></dt>
<dd>Container image full address (with registry) the image was built into and can
be referenced by to push somewhere else.</dd>
<dt><strong><code>container_image_build_short_address</code></strong> :&ensp;<code>str</code></dt>
<dd>Container image short address (without registry) the image was built into and can
be referenced by to push somewhere else, assuming the registry is on the local container
search path.</dd>
</dl>
<h2 id="results">Results</h2>
<p>step_result : StepResult
The given StepResult which was modified in place.
Returned for convenience / and clarity.</p></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.container_registries_login"><code class="name flex">
<span>def <span class="ident">container_registries_login</span></span>(<span>registries, containers_config_auth_file=None, containers_config_tls_verify=True, container_command_short_name=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Logs into one or more container registries.</p>
<p>Requires one of the following to be installed to do the authentication:
* buidlah
* podman
* skopeo</p>
<h2 id="notes">Notes</h2>
<p>registries example 1 (dict of dicts where child dict keys are registry uri):</p>
<pre><code>{
    'registry.redhat.io': {
        'username': 'hello@world.xyz',
        'password': 'nope'
    },
    'registry.internal.example.xyz': {
        'username': 'hello@example.xyz',
        'password': 'nope'
    }
}
</code></pre>
<p>registries example 2 (dict of dicts where uri is key in child dicts):</p>
<pre><code>{
    'redhat': {
        'uri': registry.redhat.io
        'username': 'hello@world.xyz',
        'password': 'nope'
    },
    'internal': {
        'uri': 'registry.internal.example.xyz'
        'username': 'hello@example.xyz',
        'password': 'nope'
    }
}
</code></pre>
<p>registries example 3 (list of dicts where uri is key in child dicts):</p>
<pre><code>[
    {
        'uri': registry.redhat.io
        'username': 'hello@world.xyz',
        'password': 'nope'
    },
    {
        'uri': 'registry.internal.example.xyz'
        'username': 'hello@example.xyz',
        'password': 'nope'
    }
]
</code></pre>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>registries</code></strong> :&ensp;<code>dict</code> or <code>list</code> or <code>None</code></dt>
<dd>Dict of dicts of registry configurations or a list of dicts of registry configurations.
See Notes section for details.
If none, does nothing.</dd>
<dt><strong><code>containers_config_auth_file</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>Path of the authentication file.
If not specified default of the underlying authentication system will be used.</dd>
<dt><strong><code>container_command_short_name</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>Short name for the command to log in with.
If not provided will pick the first command found in order (buildah, podman, skopeo).</dd>
</dl>
<h2 id="see-also">See Also</h2>
<dl>
<dt><code><a title="ploigos_step_runner.utils.containers.container_registry_login" href="#ploigos_step_runner.utils.containers.container_registry_login">container_registry_login()</a></code></dt>
<dd>Performs the login for a single container registry</dd>
<dt><code>sh.buildah</code></dt>
<dd><a href="https://www.mankier.com/1/buildah-login">https://www.mankier.com/1/buildah-login</a></dd>
<dt><code>sh.podman</code></dt>
<dd><a href="https://www.mankier.com/1/podman-login">https://www.mankier.com/1/podman-login</a></dd>
<dt><code>sh.skopeo</code></dt>
<dd><a href="https://www.mankier.com/1/skopeo-login">https://www.mankier.com/1/skopeo-login</a></dd>
</dl></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.container_registry_login"><code class="name flex">
<span>def <span class="ident">container_registry_login</span></span>(<span>container_registry_uri, container_registry_username, container_registry_password, container_registry_tls_verify=True, containers_config_auth_file=None, container_command_short_name=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Performs the login for a single container registry.</p>
<p>Requires one of the following to be installed to do the authentication:
* buidlah
* podman
* skopeo</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>container_registry_uri</code></strong> :&ensp;<code>str</code> or <code>ConfigValue</code></dt>
<dd>URI to the container registry to log into.</dd>
<dt><strong><code>container_registry_username</code></strong> :&ensp;<code>str</code> or <code>ConfigValue</code></dt>
<dd>Username to log into the container registry with.</dd>
<dt><strong><code>container_registry_password</code></strong> :&ensp;<code>str</code> or <code>ConfigValue</code></dt>
<dd>Password to log into the container registry with.</dd>
<dt><strong><code>container_registry_tls_verify</code></strong> :&ensp;<code>bool</code> or <code>str</code> or <code>ConfigValue</code></dt>
<dd>True to verify container registry certificates as part of authenticating.
False to ignore certificate chain.
NOTE: no matter what SSL is used to authenticate with container registry</dd>
<dt><strong><code>containers_config_auth_file</code></strong> :&ensp;<code>str</code> or <code>ConfigValue</code>, optional</dt>
<dd>Path of the authentication file.
If not specified default of the underlying authentication system will be used.</dd>
<dt><strong><code>container_command_short_name</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>Short name for the command to log in with.
If not provided will pick the first command found in order (buildah, podman, skopeo).</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>When can not find tool to login to container registry with.
When error loging into container registry.</dd>
</dl>
<h2 id="see-also">See Also</h2>
<dl>
<dt><code><a title="ploigos_step_runner.utils.containers.container_registries_login" href="#ploigos_step_runner.utils.containers.container_registries_login">container_registries_login()</a></code></dt>
<dd>authenticate with multiple container registries</dd>
<dt><code>sh.buildah</code></dt>
<dd><a href="https://www.mankier.com/1/buildah-login">https://www.mankier.com/1/buildah-login</a></dd>
<dt><code>sh.podman</code></dt>
<dd><a href="https://www.mankier.com/1/podman-login">https://www.mankier.com/1/podman-login</a></dd>
<dt><code>sh.skopeo</code></dt>
<dd><a href="https://www.mankier.com/1/skopeo-login">https://www.mankier.com/1/skopeo-login</a></dd>
</dl></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.create_container_from_image"><code class="name flex">
<span>def <span class="ident">create_container_from_image</span></span>(<span>image_address, repository_type='container-storage:')</span>
</code></dt>
<dd>
<div class="desc"><p>Import a container image using buildah form a TAR file.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>image_address</code></strong> :&ensp;<code>str</code></dt>
<dd>Image tag to create a container from.
ex:
* localhost/my-app:latest
* quay.io/my-org/my-app:latest
* docker-archive:/local/path/to/my-app-container-image.tar</dd>
<dt><strong><code>container_name</code></strong> :&ensp;<code>str</code></dt>
<dd>name for the working container.</dd>
<dt><strong><code>repository_type</code></strong> :&ensp;<code>str</code></dt>
<dd>The type of repository to mount the given image tag from.
See <a href="https://github.com/containers/skopeo">https://github.com/containers/skopeo</a> for details on different repository types.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Name of the imported container.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If error importing image.</dd>
</dl></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.determine_container_image_address_info"><code class="name flex">
<span>def <span class="ident">determine_container_image_address_info</span></span>(<span>contaimer_image_registry, container_image_tag, organization, application_name, service_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Determines the full and short build tags for a new container image.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>container_image_tag</code></strong> :&ensp;<code>str</code></dt>
<dd>A given image version. If none given, latest will be used.</dd>
<dt><strong><code>organization</code></strong> :&ensp;<code>str</code></dt>
<dd>Organization the container image belongs to.</dd>
<dt><strong><code>application_name</code></strong> :&ensp;<code>str</code></dt>
<dd>Application the container image belongs to.</dd>
<dt><strong><code>service_name</code></strong> :&ensp;<code>str</code></dt>
<dd>Service the container image implements.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str, str, str, str, str</code></dt>
<dd>First result is the full build tag, including registry URI.
Second result is the short build tag, as in no registry URI.
Third result is the image registry uri.
Forth result is the image repository name.
Fifth result is the used image version.</dd>
</dl></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.get_container_image_digest"><code class="name flex">
<span>def <span class="ident">get_container_image_digest</span></span>(<span>container_image_address, containers_config_auth_file=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Get the container image digest for a given container image.</p>
<p>Will pull the given container image if needed.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>container_image_address</code></strong> :&ensp;<code>str</code></dt>
<dd>URI to the container image to get the container image digest for.</dd>
<dt><strong><code>containers_config_auth_file</code></strong> :&ensp;<code>str</code></dt>
<dd>Path to container image registries authentication file.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If error inspecting container image to get digest.
If error finding digest on container image inspection results.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Container image digest for given container image.</dd>
</dl></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.inspect_container_image"><code class="name flex">
<span>def <span class="ident">inspect_container_image</span></span>(<span>container_image_address, containers_config_auth_file=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Inspects a given container image for all its details. Useful for getting image labels
and such.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>container_image_address</code></strong> :&ensp;<code>str</code></dt>
<dd>URI to the container image to inspect</dd>
<dt><strong><code>containers_config_auth_file</code></strong> :&ensp;<code>str</code></dt>
<dd>Path to container image registries authentication file.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If issue running <code>buildah inspect</code></dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dict</code></dt>
<dd>Container image details from <code>buildah inspect</code></dd>
</dl></div>
</dd>
<dt id="ploigos_step_runner.utils.containers.mount_container"><code class="name flex">
<span>def <span class="ident">mount_container</span></span>(<span>buildah_unshare_command, container_id)</span>
</code></dt>
<dd>
<div class="desc"><p>Use buildah to mount a container.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>buildah_unshare_command</code></strong> :&ensp;<code>sh.buildah.unshare.bake()</code></dt>
<dd>A baked sh.buildah.unshare command to use to run this command in the context off
so that this can be done "rootless".</dd>
<dt><strong><code>container_id</code></strong> :&ensp;<code>str</code></dt>
<dd>ID of the container to mount.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Absolute path to the mounted container.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If error mounting the container.</dd>
</dl></div>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="ploigos_step_runner.utils" href="index.html">ploigos_step_runner.utils</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="ploigos_step_runner.utils.containers.add_container_build_step_result_artifacts" href="#ploigos_step_runner.utils.containers.add_container_build_step_result_artifacts">add_container_build_step_result_artifacts</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.container_registries_login" href="#ploigos_step_runner.utils.containers.container_registries_login">container_registries_login</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.container_registry_login" href="#ploigos_step_runner.utils.containers.container_registry_login">container_registry_login</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.create_container_from_image" href="#ploigos_step_runner.utils.containers.create_container_from_image">create_container_from_image</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.determine_container_image_address_info" href="#ploigos_step_runner.utils.containers.determine_container_image_address_info">determine_container_image_address_info</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.get_container_image_digest" href="#ploigos_step_runner.utils.containers.get_container_image_digest">get_container_image_digest</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.inspect_container_image" href="#ploigos_step_runner.utils.containers.inspect_container_image">inspect_container_image</a></code></li>
<li><code><a title="ploigos_step_runner.utils.containers.mount_container" href="#ploigos_step_runner.utils.containers.mount_container">mount_container</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.1</a>.</p>
</footer>
</body>
</html>
