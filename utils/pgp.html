<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>ploigos_step_runner.utils.pgp API documentation</title>
<meta name="description" content="Shared utils for dealing with PGP keys â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>ploigos_step_runner.utils.pgp</code></h1>
</header>
<section id="section-intro">
<p>Shared utils for dealing with PGP keys.</p>
<p>Note that these functions use the "gpg" program to interact with PGP keys, but as PGP is the
standard and GPG is an implementation of that standard, we universally refer to anything having
to do with PGP keys as "PGP" rather then "GPG".</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Shared utils for dealing with PGP keys.

Note that these functions use the &#34;gpg&#34; program to interact with PGP keys, but as PGP is the
standard and GPG is an implementation of that standard, we universally refer to anything having
to do with PGP keys as &#34;PGP&#34; rather then &#34;GPG&#34;.
&#34;&#34;&#34;

import re
import sys
from io import StringIO
import sh

from ploigos_step_runner.utils.io import create_sh_redirect_to_multiple_streams_fn_callback

def detach_sign_with_pgp_key(file_to_sign_path, pgp_private_key_fingerprint, output_signature_path):
    &#34;&#34;&#34;Does a detached sign of a given file using a given users private key.

    Parameters
    ----------
    file_to_sign_path : str
        Path to file to create a detached PGP signature for.

    pgp_private_key_fingerprint : str
        PGP private key fingerprint to sign the given file with.

    output_signature_path : str
        File path to put the detached signature in.

    Raises
    ------
    RuntimeError
        If error signing given file with given key.
    &#34;&#34;&#34;
    try:
        sh.gpg( # pylint: disable=no-member
            &#39;--armor&#39;,
            &#39;--local-user&#39;,
            pgp_private_key_fingerprint,
            &#39;--output&#39;,
            output_signature_path,
            &#39;--detach-sign&#39;,
            file_to_sign_path
        )
    except sh.ErrorReturnCode as error:
        raise RuntimeError(
            f&#34;Error performing detached signature of file ({file_to_sign_path})&#34; \
            f&#34; with PGP key ({pgp_private_key_fingerprint}): {error}&#34;
        ) from error

def import_pgp_key(pgp_private_key):
    &#34;&#34;&#34;Imports a PGP key.

    Parameters
    ----------
    pgp_private_key : str
        PGP key to import.

    Returns
    -------
    str
        Fingerprint of the imported PGP key.

    Raises
    ------
    RuntimeError
        If error getting PGP fingerprint for imported PGP key
        If error importing PGP key.
    &#34;&#34;&#34;
    # Example input to match on:
    #   sec:-:3072:1:CF4AC14A3D109637:1601483310:1664555310::-:::scESC::::::23::0:
    #   fpr:::::::::DD7208BA0A6359F65B906B29CF4AC14A3D109637:
    #   grp:::::::::A483EE079EC1D58A954E3AAF3BCC61EDD7596BF0:
    gpg_regex = re.compile(r&#34;^fpr:+([^:]+):$&#34;, re.MULTILINE)

    print(&#34;Import PGP private key to sign artifacts with&#34;)
    try:
        # import the key

        # NOTE: GPG is weird in that it sends &#34;none error&#34; output to stderr even on success...
        #       so merge the stderr into stdout
        gpg_import_stdout_result = StringIO()
        gpg_import_stdout_callback = create_sh_redirect_to_multiple_streams_fn_callback([
            sys.stdout,
            gpg_import_stdout_result
        ])
        sh.gpg( # pylint: disable=no-member
            &#39;--import&#39;,
            &#39;--fingerprint&#39;,
            &#39;--with-colons&#39;,
            &#39;--import-options=import-show&#39;,
            _in=pgp_private_key,
            _out=gpg_import_stdout_callback,
            _err_to_out=True,
            _tee=&#39;out&#39;
        )

        # get the fingerprint of the imported key
        #
        # NOTE: if more then one match just using first one...
        gpg_imported_pgp_private_key_fingerprints = re.findall(
            gpg_regex,
            gpg_import_stdout_result.getvalue()
        )
        if len(gpg_imported_pgp_private_key_fingerprints) &lt; 1:
            raise RuntimeError(
                &#34;Error getting PGP fingerprint for PGP key&#34;
                &#34; to sign container image(s) with. See stdout and stderr for more info.&#34;
            )
        pgp_private_key_fingerprint = gpg_imported_pgp_private_key_fingerprints[0]

        print(
            &#34;Imported PGP private key to sign artifacts with: &#34;
            f&#34;fingerprint=&#39;{pgp_private_key_fingerprint}&#39;&#34;
        )
    except sh.ErrorReturnCode as error:
        raise RuntimeError(
            f&#34;Error importing pgp private key: {error}&#34;
        ) from error

    return pgp_private_key_fingerprint

def export_pgp_public_key(pgp_private_key_fingerprint):
    &#34;&#34;&#34;Exports a PGP public key given a private key fingerprint.

    Parameters
    ----------
    pgp_private_key_fingerprint : str
        PGP fingerprint.

    Returns
    -------
    str
        Public key from the private key fingerprint.

    Raises
    ------
    RuntimeError
        If error getting exported PGP public key
    &#34;&#34;&#34;
    try:
        gpg_export_stdout_result = StringIO()

        sh.gpg( # pylint: disable=no-member
            &#39;--armor&#39;,
            &#39;--export&#39;,
            pgp_private_key_fingerprint,
            _out=gpg_export_stdout_result,
            _err_to_out=False,
            _tee=&#39;out&#39;
        )

        gpg_public_key = gpg_export_stdout_result.getvalue()
    except sh.ErrorReturnCode as error:
        raise RuntimeError(
            f&#34;Error exporting pgp public key: {error}&#34;
        ) from error

    return gpg_public_key</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="ploigos_step_runner.utils.pgp.detach_sign_with_pgp_key"><code class="name flex">
<span>def <span class="ident">detach_sign_with_pgp_key</span></span>(<span>file_to_sign_path, pgp_private_key_fingerprint, output_signature_path)</span>
</code></dt>
<dd>
<div class="desc"><p>Does a detached sign of a given file using a given users private key.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>file_to_sign_path</code></strong> :&ensp;<code>str</code></dt>
<dd>Path to file to create a detached PGP signature for.</dd>
<dt><strong><code>pgp_private_key_fingerprint</code></strong> :&ensp;<code>str</code></dt>
<dd>PGP private key fingerprint to sign the given file with.</dd>
<dt><strong><code>output_signature_path</code></strong> :&ensp;<code>str</code></dt>
<dd>File path to put the detached signature in.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If error signing given file with given key.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def detach_sign_with_pgp_key(file_to_sign_path, pgp_private_key_fingerprint, output_signature_path):
    &#34;&#34;&#34;Does a detached sign of a given file using a given users private key.

    Parameters
    ----------
    file_to_sign_path : str
        Path to file to create a detached PGP signature for.

    pgp_private_key_fingerprint : str
        PGP private key fingerprint to sign the given file with.

    output_signature_path : str
        File path to put the detached signature in.

    Raises
    ------
    RuntimeError
        If error signing given file with given key.
    &#34;&#34;&#34;
    try:
        sh.gpg( # pylint: disable=no-member
            &#39;--armor&#39;,
            &#39;--local-user&#39;,
            pgp_private_key_fingerprint,
            &#39;--output&#39;,
            output_signature_path,
            &#39;--detach-sign&#39;,
            file_to_sign_path
        )
    except sh.ErrorReturnCode as error:
        raise RuntimeError(
            f&#34;Error performing detached signature of file ({file_to_sign_path})&#34; \
            f&#34; with PGP key ({pgp_private_key_fingerprint}): {error}&#34;
        ) from error</code></pre>
</details>
</dd>
<dt id="ploigos_step_runner.utils.pgp.export_pgp_public_key"><code class="name flex">
<span>def <span class="ident">export_pgp_public_key</span></span>(<span>pgp_private_key_fingerprint)</span>
</code></dt>
<dd>
<div class="desc"><p>Exports a PGP public key given a private key fingerprint.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>pgp_private_key_fingerprint</code></strong> :&ensp;<code>str</code></dt>
<dd>PGP fingerprint.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Public key from the private key fingerprint.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If error getting exported PGP public key</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def export_pgp_public_key(pgp_private_key_fingerprint):
    &#34;&#34;&#34;Exports a PGP public key given a private key fingerprint.

    Parameters
    ----------
    pgp_private_key_fingerprint : str
        PGP fingerprint.

    Returns
    -------
    str
        Public key from the private key fingerprint.

    Raises
    ------
    RuntimeError
        If error getting exported PGP public key
    &#34;&#34;&#34;
    try:
        gpg_export_stdout_result = StringIO()

        sh.gpg( # pylint: disable=no-member
            &#39;--armor&#39;,
            &#39;--export&#39;,
            pgp_private_key_fingerprint,
            _out=gpg_export_stdout_result,
            _err_to_out=False,
            _tee=&#39;out&#39;
        )

        gpg_public_key = gpg_export_stdout_result.getvalue()
    except sh.ErrorReturnCode as error:
        raise RuntimeError(
            f&#34;Error exporting pgp public key: {error}&#34;
        ) from error

    return gpg_public_key</code></pre>
</details>
</dd>
<dt id="ploigos_step_runner.utils.pgp.import_pgp_key"><code class="name flex">
<span>def <span class="ident">import_pgp_key</span></span>(<span>pgp_private_key)</span>
</code></dt>
<dd>
<div class="desc"><p>Imports a PGP key.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>pgp_private_key</code></strong> :&ensp;<code>str</code></dt>
<dd>PGP key to import.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>Fingerprint of the imported PGP key.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>RuntimeError</code></dt>
<dd>If error getting PGP fingerprint for imported PGP key
If error importing PGP key.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def import_pgp_key(pgp_private_key):
    &#34;&#34;&#34;Imports a PGP key.

    Parameters
    ----------
    pgp_private_key : str
        PGP key to import.

    Returns
    -------
    str
        Fingerprint of the imported PGP key.

    Raises
    ------
    RuntimeError
        If error getting PGP fingerprint for imported PGP key
        If error importing PGP key.
    &#34;&#34;&#34;
    # Example input to match on:
    #   sec:-:3072:1:CF4AC14A3D109637:1601483310:1664555310::-:::scESC::::::23::0:
    #   fpr:::::::::DD7208BA0A6359F65B906B29CF4AC14A3D109637:
    #   grp:::::::::A483EE079EC1D58A954E3AAF3BCC61EDD7596BF0:
    gpg_regex = re.compile(r&#34;^fpr:+([^:]+):$&#34;, re.MULTILINE)

    print(&#34;Import PGP private key to sign artifacts with&#34;)
    try:
        # import the key

        # NOTE: GPG is weird in that it sends &#34;none error&#34; output to stderr even on success...
        #       so merge the stderr into stdout
        gpg_import_stdout_result = StringIO()
        gpg_import_stdout_callback = create_sh_redirect_to_multiple_streams_fn_callback([
            sys.stdout,
            gpg_import_stdout_result
        ])
        sh.gpg( # pylint: disable=no-member
            &#39;--import&#39;,
            &#39;--fingerprint&#39;,
            &#39;--with-colons&#39;,
            &#39;--import-options=import-show&#39;,
            _in=pgp_private_key,
            _out=gpg_import_stdout_callback,
            _err_to_out=True,
            _tee=&#39;out&#39;
        )

        # get the fingerprint of the imported key
        #
        # NOTE: if more then one match just using first one...
        gpg_imported_pgp_private_key_fingerprints = re.findall(
            gpg_regex,
            gpg_import_stdout_result.getvalue()
        )
        if len(gpg_imported_pgp_private_key_fingerprints) &lt; 1:
            raise RuntimeError(
                &#34;Error getting PGP fingerprint for PGP key&#34;
                &#34; to sign container image(s) with. See stdout and stderr for more info.&#34;
            )
        pgp_private_key_fingerprint = gpg_imported_pgp_private_key_fingerprints[0]

        print(
            &#34;Imported PGP private key to sign artifacts with: &#34;
            f&#34;fingerprint=&#39;{pgp_private_key_fingerprint}&#39;&#34;
        )
    except sh.ErrorReturnCode as error:
        raise RuntimeError(
            f&#34;Error importing pgp private key: {error}&#34;
        ) from error

    return pgp_private_key_fingerprint</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="ploigos_step_runner.utils" href="index.html">ploigos_step_runner.utils</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="ploigos_step_runner.utils.pgp.detach_sign_with_pgp_key" href="#ploigos_step_runner.utils.pgp.detach_sign_with_pgp_key">detach_sign_with_pgp_key</a></code></li>
<li><code><a title="ploigos_step_runner.utils.pgp.export_pgp_public_key" href="#ploigos_step_runner.utils.pgp.export_pgp_public_key">export_pgp_public_key</a></code></li>
<li><code><a title="ploigos_step_runner.utils.pgp.import_pgp_key" href="#ploigos_step_runner.utils.pgp.import_pgp_key">import_pgp_key</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>